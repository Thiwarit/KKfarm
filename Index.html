<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลการทำเห็ด</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            background-color: #f1f1f1;
        }
        
        .tab-button.active {
            background-color: #4285f4;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
        }
        
        .tab-content.active {
            display: block;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-success {
            color: green;
        }
        
        .text-danger {
            color: red;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 10;
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 50%;
            max-width: 500px;
            border-radius: 5px;
        }
        
        .action-btn {
            margin-left: 5px;
            padding: 3px 8px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        /* เพิ่มสไตล์สำหรับมือถือ */
        @media (max-width: 768px) {
            .modal-content {
                width: 90%;
                margin: 20% auto;
            }
            
            .tabs {
                flex-direction: row;
                overflow-x: auto;
            }
            
            table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <h1>ระบบบันทึกข้อมูลการทำเห็ด</h1>
    <h2>เกื้อกูลฟาร์ม</h2>
    
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('mushroom-tab')">ทำก้อนเห็ด</button>
        <button class="tab-button" onclick="switchTab('harvest-tab')">เก็บเห็ด</button>
        <button class="tab-button" onclick="switchTab('finance-tab')">รายรับ-จ่าย</button>
        <button class="tab-button" onclick="switchTab('summary-tab')">สรุป</button>
    </div>
    
    <div id="mushroom-tab" class="tab-content active">
        <h3>บันทึกการทำก้อนเห็ด</h3>
        <form id="mushroom-form">
            <label for="spawn-date">วันที่หยอดเชื้อ</label>
            <input type="date" id="spawn-date" required>
            
            <label for="mushroom-type">เชื้อเห็ด</label>
            <div style="display: flex; margin-bottom: 15px;">
                <select id="mushroom-type" style="flex: 1; margin-bottom: 0;">
                    <option value="เห็ดนางฟ้า">เห็ดนางฟ้า</option>
                    <option value="เห็ดหอม">เห็ดหอม</option>
                    <option value="เห็ดออรินจิ">เห็ดออรินจิ</option>
                    <option value="เห็ดเป๋าฮื้อ">เห็ดเป๋าฮื้อ</option>
                    <option value="เห็ดหูหนู">เห็ดหูหนู</option>
                </select>
                <button type="button" onclick="showAddTypeModal()" style="width: auto; margin-left: 10px;">+</button>
            </div>
            
            <label for="block-count">จำนวนก้อน</label>
            <input type="number" id="block-count" min="1" required>
            
            <label for="notes-spawn">หมายเหตุ</label>
            <textarea id="notes-spawn" rows="2"></textarea>
            
            <button type="submit">บันทึกข้อมูล</button>
        </form>
        
        <h4>ข้อมูลล่าสุด</h4>
        <table>
            <thead>
                <tr>
                    <th>วันที่</th>
                    <th>เชื้อเห็ด</th>
                    <th style="text-align: right;">จำนวน</th>
                    <th>การจัดการ</th>
                </tr>
            </thead>
            <tbody id="mushroom-data">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
    </div>
    
    <div id="harvest-tab" class="tab-content">
        <h3>บันทึกการเก็บเห็ด</h3>
        <form id="harvest-form">
            <label for="harvest-date">วันที่เก็บ</label>
            <input type="date" id="harvest-date" required>
            
            <label for="harvest-type">ชนิดเห็ด</label>
            <div style="display: flex; margin-bottom: 15px;">
                <select id="harvest-type" style="flex: 1; margin-bottom: 0;">
                    <option value="เห็ดนางฟ้า">เห็ดนางฟ้า</option>
                    <option value="เห็ดหอม">เห็ดหอม</option>
                    <option value="เห็ดออรินจิ">เห็ดออรินจิ</option>
                    <option value="เห็ดเป๋าฮื้อ">เห็ดเป๋าฮื้อ</option>
                    <option value="เห็ดหูหนู">เห็ดหูหนู</option>
                </select>
                <button type="button" onclick="showAddTypeModal()" style="width: auto; margin-left: 10px;">+</button>
            </div>
            
            <label for="harvest-weight">น้ำหนักเห็ด (กรัม)</label>
            <input type="number" id="harvest-weight" min="1" required>
            
            <label for="cluster-count">จำนวนช่อ (ถ้ามี)</label>
            <input type="number" id="cluster-count" min="0">
            
            <label for="notes-harvest">หมายเหตุ</label>
            <textarea id="notes-harvest" rows="2"></textarea>
            
            <button type="submit">บันทึกข้อมูล</button>
        </form>
        
        <h4>ข้อมูลล่าสุด</h4>
        <table>
            <thead>
                <tr>
                    <th>วันที่</th>
                    <th>ชนิดเห็ด</th>
                    <th style="text-align: right;">น้ำหนัก (ก.)</th>
                    <th>การจัดการ</th>
                </tr>
            </thead>
            <tbody id="harvest-data">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
    </div>
    
    <div id="finance-tab" class="tab-content">
        <h3>บันทึกรายรับ-รายจ่าย</h3>
        <form id="finance-form">
            <label for="finance-date">วันที่</label>
            <input type="date" id="finance-date" required>
            
            <label for="finance-type">ชนิดเห็ด</label>
            <div style="display: flex; margin-bottom: 15px;">
                <select id="finance-type" style="flex: 1; margin-bottom: 0;">
                    <option value="เห็ดนางฟ้า">เห็ดนางฟ้า</option>
                    <option value="เห็ดหอม">เห็ดหอม</option>
                    <option value="เห็ดออรินจิ">เห็ดออรินจิ</option>
                    <option value="เห็ดเป๋าฮื้อ">เห็ดเป๋าฮื้อ</option>
                    <option value="เห็ดหูหนู">เห็ดหูหนู</option>
                    <option value="ค่าใช้จ่ายทั่วไป">ค่าใช้จ่ายทั่วไป</option>
                </select>
                <button type="button" onclick="showAddTypeModal()" style="width: auto; margin-left: 10px;">+</button>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="sale-kg">ขาย จำนวน (กก.)</label>
                    <input type="number" id="sale-kg" min="0" step="0.1">
                </div>
                
                <div style="flex: 1;">
                    <label for="sale-pack">ขาย จำนวน (ถุง)</label>
                    <input type="number" id="sale-pack" min="0">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="income">รายรับ (บาท)</label>
                    <input type="number" id="income" min="0">
                </div>
                
                <div style="flex: 1;">
                    <label for="expense">รายจ่าย (บาท)</label>
                    <input type="number" id="expense" min="0">
                </div>
            </div>
            
            <label for="notes-finance">หมายเหตุ</label>
            <textarea id="notes-finance" rows="2"></textarea>
            
            <button type="submit">บันทึกข้อมูล</button>
        </form>
        
        <h4>ข้อมูลล่าสุด</h4>
        <table>
            <thead>
                <tr>
                    <th>วันที่</th>
                    <th>ชนิดเห็ด</th>
                    <th style="text-align: right;">รายรับ</th>
                    <th style="text-align: right;">รายจ่าย</th>
                    <th>การจัดการ</th>
                </tr>
            </thead>
            <tbody id="finance-data">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
    </div>
    
    <div id="summary-tab" class="tab-content">
        <h3>สรุปข้อมูล</h3>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label for="start-date">วันที่เริ่มต้น</label>
                <input type="date" id="start-date">
            </div>
            
            <div style="flex: 1; min-width: 200px;">
                <label for="end-date">วันที่สิ้นสุด</label>
                <input type="date" id="end-date">
            </div>
        </div>
        
        <label for="summary-type">ชนิดเห็ด</label>
        <select id="summary-type" style="margin-bottom: 15px;">
            <option value="ทั้งหมด">ทั้งหมด</option>
            <option value="เห็ดนางฟ้า">เห็ดนางฟ้า</option>
            <option value="เห็ดหอม">เห็ดหอม</option>
            <option value="เห็ดออรินจิ">เห็ดออรินจิ</option>
            <option value="เห็ดเป๋าฮื้อ">เห็ดเป๋าฮื้อ</option>
            <option value="เห็ดหูหนู">เห็ดหูหนู</option>
            <option value="ค่าใช้จ่ายทั่วไป">ค่าใช้จ่ายทั่วไป</option>
        </select>
        
        <button onclick="generateSummaryReport()">ค้นหาข้อมูล</button>
        
        <h4>สรุปผลรวม</h4>
        <table>
            <thead>
                <tr>
                    <th>ชนิดเห็ด</th>
                    <th style="text-align: right;">จำนวนเก็บ</th>
                    <th style="text-align: right;">จำนวนขาย</th>
                    <th style="text-align: right;">รายรับ</th>
                    <th style="text-align: right;">รายจ่าย</th>
                    <th style="text-align: right;">กำไรสุทธิ</th>
                </tr>
            </thead>
            <tbody id="summary-data">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
        
        <h4>ข้อมูลรายวัน</h4>
        <table>
            <thead>
                <tr>
                    <th>วันที่</th>
                    <th>ชนิดเห็ด</th>
                    <th style="text-align: right;">จำนวนเก็บ</th>
                    <th style="text-align: right;">จำนวนขาย</th>
                    <th style="text-align: right;">รายรับ</th>
                    <th style="text-align: right;">รายจ่าย</th>
                    <th style="text-align: right;">กำไรสุทธิ</th>
                </tr>
            </thead>
            <tbody id="daily-data">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
    </div>
    
    <!-- Modal สำหรับเพิ่มชนิดเห็ด -->
    <div id="add-type-modal" class="modal">
        <div class="modal-content">
            <h3>เพิ่มชนิดเห็ด</h3>
            <label for="new-mushroom-type">ชื่อชนิดเห็ด</label>
            <input type="text" id="new-mushroom-type">
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="hideAddTypeModal()" style="background-color: #ccc; color: black; margin-right: 10px;">ยกเลิก</button>
                <button onclick="addNewMushroomType()">เพิ่ม</button>
            </div>
        </div>
    </div>
    
    <script>
        // แทนที่ด้วย URL ของ Web App ที่คุณได้
        const API_URL = 'https://script.google.com/macros/s/AKfycbyUwEBHi4hzfbLAyZfGdeOd10SB3fPs5MgDQlaIkaKn4lQqqL0GqMBLZZPTLIXHmW3z2Q/exec';
        let mushroomTypes = ["เห็ดนางรม"];
        const currentDate = new Date().toISOString().split('T')[0]; // Today's date in YYYY-MM-DD format
        
        // Function to switch tabs
        function switchTab(tabId) {
            // Hide all tabs
            var tabcontents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabcontents.length; i++) {
                tabcontents[i].style.display = "none";
                tabcontents[i].classList.remove("active");
            }
            
            // Remove active class from all tab buttons
            var tablinks = document.getElementsByClassName("tab-button");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            // Show the selected tab
            document.getElementById(tabId).style.display = "block";
            document.getElementById(tabId).classList.add("active");
            
            // Add active class to the button that opened the tab
            var activeTabIndex = ["mushroom-tab", "harvest-tab", "finance-tab", "summary-tab"].indexOf(tabId);
            if (activeTabIndex >= 0) {
                tablinks[activeTabIndex].classList.add("active");
            }
        }
        
        // Modal Functions
        function showAddTypeModal() {
            document.getElementById("add-type-modal").style.display = "block";
            document.getElementById("new-mushroom-type").focus();
        }
        
        function hideAddTypeModal() {
            document.getElementById("add-type-modal").style.display = "none";
        }
        
        // เพิ่มชนิดเห็ดใหม่
        function addNewMushroomType() {
            var newType = document.getElementById("new-mushroom-type").value.trim();
            
            if (newType && !mushroomTypes.includes(newType)) {
                mushroomTypes.push(newType);
                updateDropdowns();
                
                // บันทึกชนิดเห็ดใหม่ลง Google Sheets
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "addType",
                        type: newType
                    })
                })
                .then(response => response.json())
                .catch(error => console.error("Error adding mushroom type:", error));
                
                document.getElementById("new-mushroom-type").value = "";
                hideAddTypeModal();
            } else {
                alert("กรุณาระบุชนิดเห็ดใหม่ที่ไม่ซ้ำกับที่มีอยู่");
            }
        }
        
        // อัพเดทรายการชนิดเห็ดในทุก dropdown
        function updateDropdowns() {
            var dropdowns = [
                document.getElementById("mushroom-type"),
                document.getElementById("harvest-type"),
                document.getElementById("finance-type"),
                document.getElementById("summary-type")
            ];
            
            dropdowns.forEach(function(dropdown) {
                if (!dropdown) return;
                
                var selectedValue = dropdown.value;
                
                if (dropdown.id === "summary-type") {
                    dropdown.innerHTML = '<option value="ทั้งหมด">ทั้งหมด</option>';
                } else {
                    dropdown.innerHTML = '';
                }
                
                mushroomTypes.forEach(function(type) {
                    var option = document.createElement("option");
                    option.value = type;
                    option.textContent = type;
                    dropdown.appendChild(option);
                });
                
                if (mushroomTypes.includes(selectedValue)) {
                    dropdown.value = selectedValue;
                }
            });
        }
        
        // สำหรับบันทึกข้อมูลก้อนเห็ด
        function saveMushroomData() {
            var data = {
                action: "insert",
                sheet: "ก้อนเห็ด",
                date: document.getElementById("spawn-date").value,
                type: document.getElementById("mushroom-type").value,
                blockCount: parseInt(document.getElementById("block-count").value) || 0,
                notes: document.getElementById("notes-spawn").value
            };
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert("บันทึกข้อมูลเรียบร้อยแล้ว");
                    loadMushroomData();
                    
                    document.getElementById("block-count").value = "";
                    document.getElementById("notes-spawn").value = "";
                } else {
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                }
            })
            .catch(error => {
                console.error("Error saving data:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            });
        }
        
        // สำหรับบันทึกข้อมูลการเก็บเห็ด
        function saveHarvestData() {
            var data = {
                action: "insert",
                sheet: "เก็บเห็ด",
                date: document.getElementById("harvest-date").value,
                type: document.getElementById("harvest-type").value,
                weight: parseInt(document.getElementById("harvest-weight").value) || 0,
                clusterCount: parseInt(document.getElementById("cluster-count").value) || 0,
                notes: document.getElementById("notes-harvest").value
            };
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert("บันทึกข้อมูลเรียบร้อยแล้ว");
                    loadHarvestData();
                    
                    document.getElementById("harvest-weight").value = "";
                    document.getElementById("cluster-count").value = "";
                    document.getElementById("notes-harvest").value = "";
                } else {
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                }
            })
            .catch(error => {
                console.error("Error saving data:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            });
        }
        
        // สำหรับบันทึกข้อมูลรายรับ-รายจ่าย
        function saveFinanceData() {
            var data = {
                action: "insert",
                sheet: "รายรับ-รายจ่าย",
                date: document.getElementById("finance-date").value,
                type: document.getElementById("finance-type").value,
                saleKg: parseFloat(document.getElementById("sale-kg").value) || 0,
                salePack: parseInt(document.getElementById("sale-pack").value) || 0,
                income: parseInt(document.getElementById("income").value) || 0,
                expense: parseInt(document.getElementById("expense").value) || 0,
                notes: document.getElementById("notes-finance").value
            };
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert("บันทึกข้อมูลเรียบร้อยแล้ว");
                    loadFinanceData();
                    
                    document.getElementById("sale-kg").value = "";
                    document.getElementById("sale-pack").value = "";
                    document.getElementById("income").value = "";
                    document.getElementById("expense").value = "";
                    document.getElementById("notes-finance").value = "";
                } else {
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                }
            })
            .catch(error => {
                console.error("Error saving data:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            });
        }
        
        // สำหรับโหลดข้อมูลก้อนเห็ด
function loadMushroomData() {
    var tbody = document.getElementById("mushroom-data");
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
    
    console.log("Fetching mushroom data from API...");
    
    fetch(API_URL + '?sheet=ก้อนเห็ด&action=read')
        .then(response => {
            console.log("API response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("API response data:", data);
            
            tbody.innerHTML = "";
            
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ยังไม่มีข้อมูล</td></tr>';
                return;
            }
            
            console.log("First item:", data.data[0]);
            console.log("Available fields:", Object.keys(data.data[0]));
            
            // แสดงข้อมูลที่ได้รับ
            data.data.forEach(function(item) {
                console.log("Processing item:", item);
                
                // แปลงวันที่
                var formattedDate = "-";
                if (item["วันที่"]) {
                    try {
                        var dateString = item["วันที่"];
                        console.log("Original date string:", dateString);
                        
                        var dateObj = new Date(dateString);
                        console.log("Parsed date object:", dateObj);
                        
                        if (!isNaN(dateObj.getTime())) {
                            // แปลงเป็นรูปแบบ วัน/เดือน/พ.ศ.
                            var day = dateObj.getDate();
                            var month = dateObj.getMonth() + 1;
                            var year = dateObj.getFullYear() + 543;
                            formattedDate = day + '/' + month + '/' + year;
                            console.log("Formatted date:", formattedDate);
                        } else {
                            console.log("Invalid date");
                            formattedDate = dateString;
                        }
                    } catch (e) {
                        console.error("Error parsing date:", e);
                        formattedDate = item["วันที่"];
                    }
                }
                
                // สร้างแถวใหม่
                var row = document.createElement("tr");
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${item["ชนิดเห็ด"] || ''}</td>
                    <td style="text-align:right">${item["จำนวนก้อน"] || 0} ก้อน</td>
                    <td>
                        <button class="action-btn delete-btn" 
                          onclick="deleteData('ก้อนเห็ด', ${item.rowId}, '${formattedDate} - ${item["ชนิดเห็ด"]} - ${item["จำนวนก้อน"]} ก้อน')">
                            ลบ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(function(error) {
            console.error("Error fetching data:", error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        });
}
        // สำหรับโหลดข้อมูลการเก็บเห็ด
function loadHarvestData() {
    var tbody = document.getElementById("harvest-data");
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
    
    console.log("Fetching harvest data from API...");
    
    fetch(API_URL + '?sheet=เก็บเห็ด&action=read')
        .then(response => {
            console.log("API response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("API response data:", data);
            
            tbody.innerHTML = "";
            
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ยังไม่มีข้อมูล</td></tr>';
                return;
            }
            
            console.log("First harvest item:", data.data[0]);
            console.log("Available fields:", Object.keys(data.data[0]));
            
            // แสดงข้อมูลที่ได้รับ
            data.data.forEach(function(item) {
                console.log("Processing harvest item:", item);
                
                // แปลงวันที่
                var formattedDate = "-";
                if (item["วันที่"]) {
                    try {
                        var dateString = item["วันที่"];
                        console.log("Original date string:", dateString);
                        
                        var dateObj = new Date(dateString);
                        console.log("Parsed date object:", dateObj);
                        
                        if (!isNaN(dateObj.getTime())) {
                            // แปลงเป็นรูปแบบ วัน/เดือน/พ.ศ.
                            var day = dateObj.getDate();
                            var month = dateObj.getMonth() + 1;
                            var year = dateObj.getFullYear() + 543;
                            formattedDate = day + '/' + month + '/' + year;
                            console.log("Formatted date:", formattedDate);
                        } else {
                            console.log("Invalid date");
                            formattedDate = dateString;
                        }
                    } catch (e) {
                        console.error("Error parsing date:", e);
                        formattedDate = item["วันที่"];
                    }
                }
                
                // สร้างแถวใหม่
                var row = document.createElement("tr");
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${item["ชนิดเห็ด"] || ''}</td>
                    <td style="text-align:right">${item["น้ำหนัก"] || 0} ก.</td>
                    <td>
                        <button class="action-btn delete-btn" 
                          onclick="deleteData('เก็บเห็ด', ${item.rowId}, '${formattedDate} - ${item["ชนิดเห็ด"]} - ${item["น้ำหนัก"]} ก.')">
                            ลบ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(function(error) {
            console.error("Error fetching harvest data:", error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        });
}
       
       // สำหรับโหลดข้อมูลรายรับ-รายจ่าย
function loadFinanceData() {
    var tbody = document.getElementById("finance-data");
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
    
    console.log("Fetching finance data from API...");
    
    fetch(API_URL + '?sheet=รายรับ-รายจ่าย&action=read')
        .then(response => {
            console.log("API response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("API response data:", data);
            
            tbody.innerHTML = "";
            
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ยังไม่มีข้อมูล</td></tr>';
                return;
            }
            
            console.log("First finance item:", data.data[0]);
            console.log("Available fields:", Object.keys(data.data[0]));
            
            // แสดงข้อมูลที่ได้รับ
            data.data.forEach(function(item) {
                console.log("Processing finance item:", item);
                
                // แปลงวันที่
                var formattedDate = "-";
                if (item["วันที่"]) {
                    try {
                        var dateString = item["วันที่"];
                        
                        var dateObj = new Date(dateString);
                        
                        if (!isNaN(dateObj.getTime())) {
                            // แปลงเป็นรูปแบบ วัน/เดือน/พ.ศ.
                            var day = dateObj.getDate();
                            var month = dateObj.getMonth() + 1;
                            var year = dateObj.getFullYear() + 543;
                            formattedDate = day + '/' + month + '/' + year;
                        } else {
                            formattedDate = dateString;
                        }
                    } catch (e) {
                        console.error("Error parsing date:", e);
                        formattedDate = item["วันที่"];
                    }
                }
                
                // สร้างแถวใหม่
                var row = document.createElement("tr");
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${item["ชนิดเห็ด"] || ''}</td>
                    <td style="text-align:right">${(item["รายรับ"] || 0).toLocaleString()} บ.</td>
                    <td style="text-align:right">${(item["รายจ่าย"] || 0).toLocaleString()} บ.</td>
                    <td>
                        <button class="action-btn delete-btn" 
                          onclick="deleteData('รายรับ-รายจ่าย', ${item.rowId}, '${formattedDate} - ${item["ชนิดเห็ด"]} - รายรับ: ${item["รายรับ"] || 0} บ. รายจ่าย: ${item["รายจ่าย"] || 0} บ.')">
                            ลบ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(function(error) {
            console.error("Error fetching finance data:", error);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        });
}
       
       // สำหรับลบข้อมูล
       function deleteData(sheet, rowId, itemInfo) {
           if (confirm(`ต้องการลบข้อมูล "${itemInfo}" ใช่หรือไม่?`)) {
               fetch(API_URL, {
                   method: 'POST',
                   body: JSON.stringify({
                       action: "delete",
                       sheet: sheet,
                       rowId: rowId
                   })
               })
               .then(response => response.json())
               .then(result => {
                   if (result.success) {
                       alert("ลบข้อมูลเรียบร้อยแล้ว");
                       
                       // โหลดข้อมูลใหม่ตามประเภท Sheet
                       if (sheet === "ก้อนเห็ด") loadMushroomData();
                       else if (sheet === "เก็บเห็ด") loadHarvestData();
                       else if (sheet === "รายรับ-รายจ่าย") loadFinanceData();
                       
                       // อัพเดทสรุปข้อมูลด้วยถ้ากำลังดูอยู่
                       if (document.getElementById("summary-tab").classList.contains("active")) {
                           generateSummaryReport();
                       }
                   } else {
                       alert("เกิดข้อผิดพลาดในการลบข้อมูล");
                   }
               })
               .catch(error => {
                   console.error("Error deleting data:", error);
                   alert("เกิดข้อผิดพลาดในการลบข้อมูล");
               });
           }
       }
       
       // สำหรับสร้างรายงานสรุป
       function generateSummaryReport() {
    var startDate = document.getElementById("start-date").value;
    var endDate = document.getElementById("end-date").value;
    var selectedType = document.getElementById("summary-type").value;
    
    var summaryTbody = document.getElementById("summary-data");
    var dailyTbody = document.getElementById("daily-data");
    
    summaryTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
    dailyTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
    
    console.log("Generating summary report for dates:", startDate, "to", endDate, "type:", selectedType);
    
    // สร้างข้อมูลสรุปเองจากข้อมูลที่โหลดมา
    var harvestsByType = {};
    var financesByType = {};
    
    // ดึงข้อมูลการเก็บเห็ด
    fetch(API_URL + '?sheet=เก็บเห็ด&action=read')
        .then(response => {
            console.log("Harvest API response status:", response.status);
            return response.json();
        })
        .then(harvestData => {
            console.log("Harvest data:", harvestData);
            
            if (harvestData.data && harvestData.data.length > 0) {
                harvestData.data.forEach(function(item) {
                    // แปลงวันที่เป็นรูปแบบ YYYY-MM-DD สำหรับเปรียบเทียบ
                    var dateStr = "";
                    if (item["วันที่"]) {
                        try {
                            var dateObj = new Date(item["วันที่"]);
                            if (!isNaN(dateObj.getTime())) {
                                dateStr = dateObj.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            console.error("Error parsing harvest date:", e);
                        }
                    }
                    
                    if (dateStr >= startDate && dateStr <= endDate) {
                        // กรองตามชนิดเห็ดที่เลือก
                        if (selectedType === "ทั้งหมด" || item["ชนิดเห็ด"] === selectedType) {
                            if (!harvestsByType[item["ชนิดเห็ด"]]) {
                                harvestsByType[item["ชนิดเห็ด"]] = {
                                    totalWeight: 0,
                                    dailyData: []
                                };
                            }
                            
                            harvestsByType[item["ชนิดเห็ด"]].totalWeight += item["น้ำหนัก"] || 0;
                            harvestsByType[item["ชนิดเห็ด"]].dailyData.push({
                                date: dateStr,
                                weight: item["น้ำหนัก"] || 0
                            });
                        }
                    }
                });
            }
            
            console.log("Processed harvests:", harvestsByType);
            
            // ดึงข้อมูลการเงิน
            return fetch(API_URL + '?sheet=รายรับ-รายจ่าย&action=read');
        })
        .then(response => {
            console.log("Finance API response status:", response.status);
            return response.json();
        })
        .then(financeData => {
            console.log("Finance data:", financeData);
            
            if (financeData.data && financeData.data.length > 0) {
                financeData.data.forEach(function(item) {
                    // แปลงวันที่เป็นรูปแบบ YYYY-MM-DD สำหรับเปรียบเทียบ
                    var dateStr = "";
                    if (item["วันที่"]) {
                        try {
                            var dateObj = new Date(item["วันที่"]);
                            if (!isNaN(dateObj.getTime())) {
                                dateStr = dateObj.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            console.error("Error parsing finance date:", e);
                        }
                    }
                    
                    if (dateStr >= startDate && dateStr <= endDate) {
                        // กรองตามชนิดเห็ดที่เลือก
                        if (selectedType === "ทั้งหมด" || item["ชนิดเห็ด"] === selectedType) {
                            if (!financesByType[item["ชนิดเห็ด"]]) {
                                financesByType[item["ชนิดเห็ด"]] = {
                                    totalSaleKg: 0,
                                    totalSalePack: 0,
                                    totalIncome: 0,
                                    totalExpense: 0,
                                    dailyData: []
                                };
                            }
                            
                            financesByType[item["ชนิดเห็ด"]].totalSaleKg += item["จำนวนขาย (กก.)"] || 0;
                            financesByType[item["ชนิดเห็ด"]].totalSalePack += item["จำนวนขาย (ถุง)"] || 0;
                            financesByType[item["ชนิดเห็ด"]].totalIncome += item["รายรับ"] || 0;
                            financesByType[item["ชนิดเห็ด"]].totalExpense += item["รายจ่าย"] || 0;
                            financesByType[item["ชนิดเห็ด"]].dailyData.push({
                                date: dateStr,
                                saleKg: item["จำนวนขาย (กก.)"] || 0,
                                salePack: item["จำนวนขาย (ถุง)"] || 0,
                                income: item["รายรับ"] || 0,
                                expense: item["รายจ่าย"] || 0
                            });
                        }
                    }
                });
            }
            
            console.log("Processed finances:", financesByType);
            
            // สร้างรายงานสรุป
            generateSummaryTable(harvestsByType, financesByType);
            generateDailyTable(harvestsByType, financesByType);
        })
        .catch(function(error) {
            console.error("Error generating report:", error);
            summaryTbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
            dailyTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        });
}
                   
                   // สร้างรายงานสรุป
                  // สร้างตารางสรุป
function generateSummaryTable(harvestsByType, financesByType) {
    var tbody = document.getElementById("summary-data");
    tbody.innerHTML = "";
    
    // รวมชนิดเห็ดทั้งหมด
    var allTypes = new Set([
        ...Object.keys(harvestsByType),
        ...Object.keys(financesByType)
    ]);
    
    if (allTypes.size === 0) {
        var row = document.createElement("tr");
        row.innerHTML = '<td colspan="6" style="text-align:center;">ไม่พบข้อมูลในช่วงวันที่ที่เลือก</td>';
        tbody.appendChild(row);
        return;
    }
    
    var totalHarvest = 0;
    var totalSale = 0;
    var totalIncome = 0;
    var totalExpense = 0;
    var totalProfit = 0;
    
    allTypes.forEach(function(type) {
        var harvestData = harvestsByType[type] || { totalWeight: 0 };
        var financeData = financesByType[type] || { 
            totalSaleKg: 0, 
            totalSalePack: 0, 
            totalIncome: 0, 
            totalExpense: 0 
        };
        
        var harvest = harvestData.totalWeight;
        var sale = financeData.totalSaleKg;
        var income = financeData.totalIncome;
        var expense = financeData.totalExpense;
        var profit = income - expense;
        
        totalHarvest += harvest;
        totalSale += sale;
        totalIncome += income;
        totalExpense += expense;
        totalProfit += profit;
        
        // เพิ่มแถวในตาราง
        var row = document.createElement("tr");
        row.innerHTML = `
            <td><strong>${type}</strong></td>
            <td style="text-align:right">${harvest.toLocaleString()} ก.</td>
            <td style="text-align:right">${sale.toLocaleString()} กก.</td>
            <td style="text-align:right">${income.toLocaleString()} บ.</td>
            <td style="text-align:right">${expense.toLocaleString()} บ.</td>
            <td style="text-align:right" class="${profit >= 0 ? 'text-success' : 'text-danger'}"><strong>${profit.toLocaleString()} บ.</strong></td>
        `;
        tbody.appendChild(row);
    });
    
    // เพิ่มแถวรวมทั้งหมดถ้ามีมากกว่า 1 ชนิด
    if (allTypes.size > 1) {
        var totalRow = document.createElement("tr");
        totalRow.style.backgroundColor = "#f8f9fa";
        totalRow.style.fontWeight = "bold";
        totalRow.innerHTML = `
            <td>รวมทั้งหมด</td>
            <td style="text-align:right">${totalHarvest.toLocaleString()} ก.</td>
            <td style="text-align:right">${totalSale.toLocaleString()} กก.</td>
            <td style="text-align:right">${totalIncome.toLocaleString()} บ.</td>
            <td style="text-align:right">${totalExpense.toLocaleString()} บ.</td>
            <td style="text-align:right" class="${totalProfit >= 0 ? 'text-success' : 'text-danger'}">${totalProfit.toLocaleString()} บ.</td>
        `;
        tbody.appendChild(totalRow);
    }
}

// สร้างตารางข้อมูลรายวัน
function generateDailyTable(harvestsByType, financesByType) {
    var tbody = document.getElementById("daily-data");
    tbody.innerHTML = "";
    
    // รวมข้อมูลเก็บเห็ดและการเงินตามวันที่และชนิด
    var dailyData = {};
    
    // ประมวลผลข้อมูลการเก็บเห็ด
    for (var type in harvestsByType) {
        harvestsByType[type].dailyData.forEach(function(item) {
            var key = `${item.date}_${type}`;
            
            if (!dailyData[key]) {
                dailyData[key] = {
                    date: item.date,
                    type: type,
                    harvest: 0,
                    saleKg: 0,
                    salePack: 0,
                    income: 0,
                    expense: 0
                };
            }
            
            dailyData[key].harvest += item.weight || 0;
        });
    }
    
    // ประมวลผลข้อมูลการเงิน
    for (var type in financesByType) {
        financesByType[type].dailyData.forEach(function(item) {
            var key = `${item.date}_${type}`;
            
            if (!dailyData[key]) {
                dailyData[key] = {
                    date: item.date,
                    type: type,
                    harvest: 0,
                    saleKg: 0,
                    salePack: 0,
                    income: 0,
                    expense: 0
                };
            }
            
            dailyData[key].saleKg += item.saleKg || 0;
            dailyData[key].salePack += item.salePack || 0;
            dailyData[key].income += item.income || 0;
            dailyData[key].expense += item.expense || 0;
        });
    }
    
    // แปลงเป็น array และเรียงตามวันที่
    var sortedData = Object.values(dailyData).sort(function(a, b) {
        return a.date.localeCompare(b.date) || a.type.localeCompare(b.type);
    });
    
    if (sortedData.length === 0) {
        var row = document.createElement("tr");
        row.innerHTML = '<td colspan="7" style="text-align:center;">ไม่พบข้อมูลในช่วงวันที่ที่เลือก</td>';
        tbody.appendChild(row);
        return;
    }
    
    // สร้างแถวในตาราง
    sortedData.forEach(function(data) {
        // แปลงวันที่เป็นรูปแบบ วัน/เดือน/พ.ศ.
        var formattedDate;
        try {
            var dateObj = new Date(data.date);
            var day = dateObj.getDate();
            var month = dateObj.getMonth() + 1;
            var year = dateObj.getFullYear() + 543;
            formattedDate = day + '/' + month + '/' + year;
        } catch (e) {
            formattedDate = data.date;
        }
        
        var profit = data.income - data.expense;
        
        var row = document.createElement("tr");
        row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${data.type}</td>
            <td style="text-align:right">${data.harvest.toLocaleString()} ก.</td>
            <td style="text-align:right">${data.saleKg.toLocaleString()} กก.</td>
            <td style="text-align:right">${data.income.toLocaleString()} บ.</td>
            <td style="text-align:right">${data.expense.toLocaleString()} บ.</td>
            <td style="text-align:right" class="${profit >= 0 ? 'text-success' : 'text-danger'}">${profit.toLocaleString()} บ.</td>
        `;
        tbody.appendChild(row);
    });
}
       
       // เริ่มต้นเมื่อโหลดหน้าเว็บ
       document.addEventListener('DOMContentLoaded', function() {
           try {
               // ตั้งค่าวันที่ปัจจุบัน
               document.getElementById("spawn-date").value = currentDate;
               document.getElementById("harvest-date").value = currentDate;
               document.getElementById("finance-date").value = currentDate;
               
               // ตั้งค่าช่วงวันที่สำหรับรายงานสรุป (เดือนปัจจุบัน)
               var today = new Date();
               var firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
               document.getElementById("start-date").value = firstDayOfMonth.toISOString().split('T')[0];
               document.getElementById("end-date").value = today.toISOString().split('T')[0];
               
               // ตั้งค่าการส่งฟอร์ม
               document.getElementById("mushroom-form").addEventListener("submit", function(e) {
                   e.preventDefault();
                   saveMushroomData();
               });
               
               document.getElementById("harvest-form").addEventListener("submit", function(e) {
                   e.preventDefault();
                   saveHarvestData();
               });
               
               document.getElementById("finance-form").addEventListener("submit", function(e) {
                   e.preventDefault();
                   saveFinanceData();
               });
               
               // โหลดชนิดเห็ด
               fetch(API_URL + '?action=types')
                   .then(response => response.json())
                   .then(data => {
                       if (data.types && data.types.length > 0) {
                           mushroomTypes = data.types;
                       }
                       updateDropdowns();
                   })
                   .catch(error => {
                       console.error("Error loading mushroom types:", error);
                   });
               
               // โหลดข้อมูลเริ่มต้น
               loadMushroomData();
               loadHarvestData();
               loadFinanceData();
               
               // สร้างรายงานสรุปเริ่มต้น
               setTimeout(generateSummaryReport, 1000);
           } catch (error) {
               console.error("Error initializing app:", error);
               alert("เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน โปรดลองโหลดหน้าใหม่อีกครั้ง");
           }
       });
   </script>
</body>
</html>